---
title: "Kaggle Hidden Gems"
author: "Nick Cruickshank"
date: "4/30/2022"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

# Introduction

This weeks [Tidy Tuesday Project](https://github.com/rfordatascience/tidytuesday/tree/master/data/2022/2022-04-26) comes from the [Kaggle Notebooks of the Week - Hidden Gems](https://www.kaggle.com/datasets/headsortails/notebooks-of-the-week-hidden-gems?resource=download) project, which is celebrating it's 100th installment. 

## Data Dictionary

The file of interest is kaggle_hidden_gems.csv, containing the following columns:  
 - `vol` and `date`: The consecutive number of the Hidden Gems episode and when it was first published.  
 - `link_forum` and `link_twitter`: The hyperlinks to the Kaggle Forum post and Twitter post for the episode.  
 - `notebook` and `author`: The hyperlinks to the Notebook itself, as well as to the Kaggle profile of the author.  
 - `title`: The Notebook title as a string.  
 - `review`: My brief review of the Notebook.  
 - `author_name`: The name of the Notebook author as listed on their Kaggle profile at the time the episode was published.  
 - `author_twitter` and author_linkedin: The social media links of the author, if listed on their Kaggle profile.  
 - `notes`: Notes about special episodes.  

# Analysis

## Libraries and Data

```{r libraries}
# libraries
library(lubridate)
library(tidyverse)
library(tm) # for converting text into corpus
library(wordcloud)
library(wordcloud2)
```

```{r}
# data
hidden_gems <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-04-26/hidden_gems.csv')
```

## Tidy Data Set

This data set contains a lot of useful references for authorship and links to follow for each notebook. However, for the sake of visualizing the metadata, we don't care quite as much about that.  

```{r}
hg <- hidden_gems %>%
  select(date, author_kaggle, title, review)

hidden_gems %>%
  filter(!is.na(author_twitter))
```


## EDA

Are there any authors that show up a lot?

```{r}
count(hg, author_kaggle, sort = TRUE) %>%
  head(5)
```

## Visualization

### Ideas

When do the top five contributors show up in the data set?

```{r}
top_authors <- count(hg, author_kaggle, sort = TRUE) %>%
  head(5) %>%
  pull(author_kaggle)

# not the most illuminating idea
authorship_plot <- hg %>%
  mutate(
    author_category = ifelse(author_kaggle %in% top_authors, author_kaggle, "Other"),
    month = floor_date(date, unit = "month")
  ) %>%
  count(month, author_category) %>%
  ggplot(aes(month, n)) + 
  geom_bar(aes(fill = author_category), stat = "identity")
```

Word Cloud

Very useful guide found on [Toward Data Science](https://towardsdatascience.com/create-a-word-cloud-with-r-bde3e7422e8a) on how to make a Word Cloud.

## Selenium

Need to `install.packages("RSelenium")` and to have JAVA installed on the local machine (a useful tutorial for downloading JAVA is provided by [ProgrammingKnowledge](https://www.youtube.com/watch?v=IJ-PJbvJBGs)).

Selenium Tutorial provided by [Samer Hijjazi](https://www.youtube.com/watch?v=U1BrIPmhx10). 

```{r}
## selenium libraries
library(RSelenium)
library(wdman)
library(netstat)

## create driver
driver <- rsDriver(browser = "chrome",
                   chromever = '100.0.4896.60',
                   verbose = FALSE,
                   port = free_port())

## create client object
remDr <- driver$client

remDr$close()
```

```{r}
# define function for waiting for page to load
wetest <- function(using = 'css',element = 'body',sleepmin,sleepmax){
  remDr <- get("remDr",envir=globalenv())
  webElemtest <-NULL
  while(is.null(webElemtest)){
    webElemtest <- tryCatch({remDr$findElement(using = using, element)},
                            error = function(e){NULL})
    #loop until element with name <value> is found in <webpage url>
  }
  randsleep <- sample(seq(sleepmin, sleepmax, by = 0.001), 1)
  Sys.sleep(randsleep)
}

page_not_found <- '//*[@id="site-content"]/div[3]/div/div'
page_not_found_test <- "We can't find that page.\nYou can search Kaggle above or visit our homepage."
```

```{r message=FALSE, warning=FALSE}
kaggle <- hidden_gems$notebook[15]
tweet <- hidden_gems$author_twitter[15]

# open browser
remDr$open()

# go to kaggle link
remDr$navigate(tweet)
wetest(sleepmin = 0.5, sleepmax = 1)

# finding elements

## twitter

### number of twitter followers
followers_element <- '//*[@id="react-root"]/div/div/div[2]/main/div/div/div/div[1]/div/div[2]/div/div/div/div/div[5]/div[2]'

# webElem <- NULL
# while(is.null(webElem)) {
#   webElem <- tryCatch({remDr$findElement(using = "xpath", followers_element)},
#                       error = function(e){NULL})
# }

followers_xpath <- remDr$findElement(using = "xpath", followers_element)
followers <- followers_xpath$getElementText()

## kaggle
remDr$navigate(kaggle)
wetest(sleepmin = 0.5, sleepmax = 1)
page_exists_xpath <- remDr$findElement(using = 'xpath', '//*[@id="site-content"]/div[3]/div/div')
page_exists_value <- page_exists_xpath$getElementText()

if (page_exists_value == page_not_found_test) {
  views <- NULL
  upvotes <- NULL
  comments <- NULL
} else{
  ### notebook language
  language_element <- '//*[@id="site-content"]/div[3]/div[3]/div/div[2]/div[1]/span'
  
  #### wait for page to load
  wetest(sleepmin = 0.5, sleepmax = 1)
  
  language_xpath <- remDr$findElement(using = "xpath", language_element)
  language <- language_xpath$getElementText()
  
  ### views
  views_xpath <- remDr$findElement(using = "xpath", '//*[@id="site-content"]/div[3]/div[3]/div/div[1]/span/span[2]')
  views <- views_xpath$getElementText()
  
  ### upvotes
  upvotes_xpath <- remDr$findElement(using = "xpath", '//*[@id="site-content"]/div[3]/div[3]/div/div[1]/div/div[1]/div/button[2]')
  upvotes <- upvotes_xpath$getElementText()
  
  ### comments
  comments_xpath <- remDr$findElement(using = "xpath", '//*[@id="site-content"]/div[3]/div[5]/div[1]/div/div/div/button[5]/div')
  comments <- comments_xpath$getElementText()
}

paste0("Followers: ", followers, " || Views: ", views, " || Upvotes: ", upvotes, " || Comments: ", comments)

remDr$close()
```

```{r}
# twitter identifiers
twitter_loaded <- remDr$findElement(using = 'xpath', '//*[@id="react-root"]/div/div/div[2]/header/div/div/div/div')
twitter_loaded$getElementText()

test_tweets <- head(list(hidden_gems$author_twitter)[[1]], 3)
twitter_profiles <- hidden_gems %>%
  filter(!is.na(author_twitter)) %>%
  pull(author_twitter)

account_does_not_exist <- "https://twitter.com/CaptCalculator"
does_not_exist_xpath <- ""
```

```{r message=FALSE, warning=FALSE}
# iterate over each row of the hidden_gems df
selenium_df <- NULL

for (profile in twitter_profiles) {
  
  # # define relevant URLs
  # tweet <- hidden_gems[row, "author_twitter"]
  # kaggle <- hidden_gems[row, "notebook"]
  
  remDr$open()
  Sys.sleep(3)
  
  # retrieve data from twitter
  if (!is.na(profile)) {
    # navigate to twitter page and wait for it to load
    remDr$navigate(profile)
    Sys.sleep(3)
  
    # NEED TO ADD AN ADDITIONAL IF STATEMENT FOR WHETHER THE PAGE EXISTS
    
    ## retrieve number of twitter followers
    followers_element <- '//*[@id="react-root"]/div/div/div[2]/main/div/div/div/div[1]/div/div[2]/div/div/div/div/div[5]/div[2]'

    followers_xpath <- remDr$findElement(using = "xpath", followers_element)
    followers <- followers_xpath$getElementText()
  } else {
    followers <- 'NULL'
  }
  
  # output to new dataframe
  output <- c(author_twitter = profile, followes = followers)
  print(output)
  selenium_df <- rbind(selenium_df, output)
  
  remDr$close()
}

colnames(selenium_df) <- c("author_twitter", "followers")
selenium_df
```

