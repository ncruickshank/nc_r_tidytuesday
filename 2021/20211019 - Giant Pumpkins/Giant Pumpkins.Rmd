---
title: "Giant Pumpkins"
author: "Nick Cruickshank"
date: "10/23/2021"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

![](https://images.unsplash.com/photo-1539395369182-84bb72ecf742?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1331&q=80)

# Introduction

Data for this weeks [Tidy Tuesday Project](https://github.com/rfordatascience/tidytuesday/tree/master/data/2021/2021-10-19) comes from [BigPunmpkins.com](http://www.bigpumpkins.com/ViewArticle.asp?id=132). 

> The Great Pumpkin Commonwealth's (GPC) mission cultivates the hobby of growing giant pumpkins throughout the world by establishing standards and regulations that ensure quality of fruit, fairness of competition, recognition of achievement, fellowship and education for all participating growers and weigh-off sites.

> Types: F = "Field Pumpkin", P = "Giant Pumpkin", S = "Giant Squash", W = "Giant Watermelon", L = "Long Gourd" (length in inches, not weight in pounds), T = Tomato

More information on how to utilize this dataset (and understand the community) can be found in the [Great Pumpkin Commonwealth Handbook](https://gpc1.org/wp-content/uploads/2021/03/GPC-Rules-and-Handbook-2021.pdf).

Image kudos to [Patrick Donnely](https://unsplash.com/@patrick).

# Data Analyis

## Libraries

```{r libraries}
# libraries
library(forcats)
library(ggbump)
library(ggridges)
library(ggtext)
library(glue)
library(mapdata)
library(maps)
library(patchwork)
library(readr)
library(sf)
library(tidyverse)
```

## Data

```{r load data}
# data
pumpkins <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-10-19/pumpkins.csv')
state_abr <- read_csv("state_abr.csv")
head(pumpkins)
```


## Tidy

Types: F = "Field Pumpkin", P = "Giant Pumpkin", S = "Giant Squash", W = "Giant Watermelon", L = "Long Gourd" (length in inches, not weight in pounds), T = Tomato

```{r}
pumpkins2 <- pumpkins %>%
  filter(country == "United States") %>%
  separate(id, into = c("year", "code"), sep = "-") %>%
  mutate(
    type = case_when(
      str_detect(code, "F") ~ "Field Pumpkin",
      str_detect(code, "P") ~ "Giant Pumpkin",
      str_detect(code, "S") ~ "Giant Squash",
      str_detect(code, "W") ~ "Giant Watermelon",
      str_detect(code, "L") ~ "Long Gourd",
      str_detect(code, "T") ~ "Tomato"
    )
  ) %>%
  mutate(
    year = as.numeric(year),
    weight_lbs = parse_number(weight_lbs)
  )
  

```


## Visualization

### Questions 

Which states have the biggest pumpkins? By type? Over time?

Which competitions have the biggest pumpkins?

For the top 10 states, how has the timeline of growth changed?

What is the different between field and giant pumpkins?

__US Map connected to extra visualizations by geom sigmoid. ALso, which were the most popular gpc sites of 2021?__

### Explroatory Data Analysis

Field pumpkins and giant pumpkins have a __very__ different weight and distribution.

```{r gourd type weight distr, fig.height=4, fig.width=10}
# what type of gourd has the greatest weight?
weight_orders <- pumpkins2 %>%
  group_by(type) %>%
  dplyr::summarise(mean_weight = mean(weight_lbs), n = n()) %>%
  ungroup() %>%
  mutate(rank = row_number()) %>%
  arrange(desc(mean_weight))

pumpkins2 %>%
  left_join(weight_orders, by = "type") %>%
  ggplot(aes(weight_lbs, fct_reorder(type, rank))) + 
  geom_density_ridges(rel_min_height = 0.01)
```

Have the number of pumpkin submissions been going up or down? Is it reasonable to plot 2021?

```{r year counts, fig.height=3, fig.width=10}
pumpkins2 %>%
  count(year) %>%
  ggplot(aes(as.character(year), n)) + 
  geom_bar(stat = "identity") + 
  geom_text(aes(label = n), vjust = 1.2) + 
  geom_text(aes(y = 200, label = year), fontface = "bold", size = 5, color = "white") + 
  theme_void()
```

Looks like 2021 is good to plot!

### Final Visualization

States

```{r pumpkin plot, fig.height=4, fig.width=10}
# states tidy
pump_states <- pumpkins2 %>%
  filter(year == 2021, type == "Giant Pumpkin")  %>%
  group_by(state_prov) %>%
  dplyr::summarise(max_weight = max(weight_lbs)) %>%
  ungroup() %>%
  mutate(region = str_to_lower(state_prov))

usa <- map_data('usa')
state <- map_data('state') %>%
  left_join(pump_states, by = "region")

list_top_states <- pump_states %>%
  arrange(desc(max_weight)) %>%
  mutate(
    rank = row_number(),
    label = paste0(rank, ". ", str_to_title(region))
  ) %>%
  head(10)

ends <- tibble(
  label = pull(list_top_states, label),
  xend = c(-30, -30, -30, -30, -30, -30, -30, -30, -30, -30),
  yend = rev(seq(21, 50, 3))
)

state_sigmoids <- state %>%
  group_by(region) %>%
  dplyr::summarise(
    x = mean(long),
    y = mean(lat)
  ) %>%
  inner_join(list_top_states, by = "region") %>%
  left_join(ends)
  

ggplot() + 
  geom_polygon(data = state, aes(long, lat, fill = max_weight, group = group), color = "darkorange4") + 
  geom_sigmoid(data = state_sigmoids, aes(x = x, y = y, xend = xend, yend = yend, group = region), color = "darkorange4", size = 1.05) +
  geom_point(data = state_sigmoids, aes(x, y), color = "darkorange4") + 
  geom_text(data = state_sigmoids, aes(x = xend + 5, y = yend, label = label), color = "darkorange4", hjust = 0) + 
  scale_fill_gradient(low = "palegoldenrod", high = "darkorange2", na.value = "grey80") + 
  #scale_color_gradient(low = "darkorange2", high = "darkorange4") + 
  scale_x_continuous(limits = c(-130, -15)) +
  coord_fixed() + 
  theme_void() + 
  theme(
    legend.position = "none"
  )
```

```{r weight boxplots, fig.height=8, fig.width=10}
# boxplots
overall_yends <- tibble(
  overall_rank = seq(1, 30, 1),
  yend = seq(0.5, 10.36, 0.34)
)

#pump_slice <- 
pumpkins2 %>%
  filter(
    state_prov %in% list_top_states$state_prov,
    year == 2021
  ) %>%
  group_by(state_prov) %>%
  slice_max(order_by = weight_lbs, n = 3) %>%
  mutate(state_rank = row_number()) %>%
  ungroup() %>%
  left_join(state_abr, by = "state_prov") %>%
  arrange(desc(weight_lbs)) %>%
  mutate(overall_rank = row_number()) %>%
  select(state_prov, state_rank, overall_rank, grower_name, gpc_site, weight_lbs, abr) %>%
  left_join(select(state_sigmoids, state_prov, rank, max_weight), by = "state_prov") %>%
  mutate(
    odd_even = if_else(rank %% 2 == TRUE, "Odd", "Even"),
    xlab = max(max_weight) + 150,
    ylab = case_when(
      as.double(state_rank) == 1 ~ as.double(rank) - 0.3,
      as.double(state_rank) == 2 ~ as.double(rank),
      as.double(state_rank) == 3 ~ as.double(rank) + 0.3
    ),
    label1 = paste0("#", state_rank, " ", gpc_site),
    x = max(state_sigmoids$max_weight) + 5500,
    y = ylab,
    xend = max(state_sigmoids$max_weight) + 10000,
    label2 = paste0("#", overall_rank, " ", weight_lbs, "lbs (", abr, ")")
  ) %>%
  left_join(overall_yends, by = "overall_rank")


pumpkins2 %>%
  filter(
    state_prov %in% list_top_states$state_prov,
    year == 2021
  ) %>%
  left_join(select(pump_slice, state_prov, rank), by = "state_prov") %>%
  ggplot(aes(weight_lbs, -rank)) + # fct_reorder(state_prov, rank, .desc = TRUE))) + 
  geom_boxplot(aes(group = rank), width = 0.25, fill = "darkorange2", color = "darkorange4") + 
  #scale_x_continuous(limits = c(0, max(state_sigmoids$max_weight) + 15000)) +
  geom_text(data = pump_slice, aes(x = xlab, y = -ylab, label = label1, color = odd_even), hjust = 0, size = 3) + 
  geom_sigmoid(data = pump_slice, aes(x = x, y = -y, xend = xend, yend = -yend, color = odd_even, group = overall_rank)) + 
  scale_color_manual(values = c("darkorange4", "forestgreen"), guide = "none") + 
  theme_minimal()
```

```{r}
# patchwork vis

```

