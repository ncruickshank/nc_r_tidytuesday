---
title: "Tidy Tuesday 20210601 - SURVIVOR"
author: "Nick Cruickshank"
date: "6/1/2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

```{r}
# libraries
library(cowplot)
library(forcats)
library(ggrepel)
library(readr)
library(tidytext)
library(tidyverse)
```

```{r}
# data
summary <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-06-01/summary.csv')
castaways <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-06-01/castaways.csv')
jury_votes <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-06-01/jury_votes.csv')
challenges <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-06-01/challenges.csv')
viewers <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-06-01/viewers.csv')
```

```{r}
# functions
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
```

# Exploratory Analysis

## Summary

```{r}
head(summary)
```

Which season had the greatest disparity between viewers at premier vs at finale?

```{r fig.height=5, fig.width=10}
# identify what the top five countries are for filling the graph
list_top5_countries <- head(arrange(count(summary, vars = country), desc(n)), 5)$vars

# reshape summary by country with "Other" category
sum_pie_df <- summary %>%
  mutate(
    country_category = ifelse(country %in% list_top5_countries, country, "Other")
  ) %>%
  group_by(country_category) %>%
  dplyr::summarise(value = n())

# colors to use by country
countries_colors <- c(
  "Brazil" = "limegreen",
  "Fiji" = "deepskyblue",
  "Nicaragua" = "royalblue",
  "Other" = "gray50",
  "Panama" = "red",
  "Philippines" = "gold"
)

# create plots
## pie chart and legen
sum_pie <- ggplot(sum_pie_df, aes(x = "", y = value, fill = country_category)) + 
  geom_bar(stat = "identity", color = "gray20") + 
  coord_polar("y", start = 0) + 
  scale_fill_manual(values = countries_colors) + 
  labs(title = "Location Breakdown", fill = "Country") +
  theme_void() + 
  theme(legend.position = "bottom")

## viewership delta
sum_delta_plot <- summary %>%
  mutate(
    viewer_delta = viewers_finale - viewers_premier,
    country_category = ifelse(country %in% list_top5_countries, country, "Other")
  ) %>%
  ggplot(aes(season, viewer_delta)) + 
  geom_line(aes(season, viewers_mean)) +
  ggrepel::geom_text_repel(
    data = filter(summary, season == 20),
    aes(season, viewers_mean), label = "Mean episode viewership\nper season"
    ) +
  geom_bar(aes(fill = country_category), stat = "identity", color = "gray20") +
  scale_fill_manual(values = countries_colors) +
  labs(
    title = "Difference between viewers at finale and viewers at premiere",
    x = "Season",
    y = "Viewers (millions)"
  ) + 
  theme_minimal() +
  theme(
    legend.position = "none",
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  )

# put the two plots together
plots_row <- plot_grid(sum_pie, sum_delta_plot, rel_widths = c(1,2))

title <- ggdraw() + 
  draw_label(
    "Survivor summary throughout the seasons",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

summary_plot <- plot_grid(
  title, plots_row,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

summary_plot
```

Looks like overall mean viewership declined throughout the seasons (no surprise). Also, the variance in the delta between viewers at finale and viewers at premiere dropped off over time. I interpret this as demonstrating that the people who watched the later seasons of the show were already enfranchised, and were thus more likely to commit to finishing the season once started.

```{r}
repeat_winners <- filter(count(summary, vars = full_name), n > 1)$vars
seasons_with_returns <- nrow(filter(summary, str_detect(tribe_setup, "(returning|past)")))
```

Looking at the winners from each season, it is clear that there were only two repeat winners: `r repeat_winners`.

Of the `r nrow(summary)` seasons of Survivor, there were `r seasons_with_returns` seasons where returning players were allowed. From those `r seasons_with_returns` emerged `r length(repeat_winners)` repeat winners: `r repeat_winners`.

## Challenges

```{r}
head(challenges)
```

```{r}
count(challenges, vars = challenge_type)
```

## Castaways

```{r}
castaways
```

__Relevant features__

Primary: Age, state, personality_type, result
Secondary: Total Votes Received, Immunity Idols Won

### Age by Season

```{r}
castaways_sum <- castaways %>%
  group_by(season) %>%
  dplyr::summarise(
    players = n_distinct(full_name),
    mode_personality = Mode(personality_type),
    min_age = min(age),
    mean_age = mean(age),
    max_age = max(age)
  )
```

```{r}
viewers %>%
  group_by(season) %>%
  dplyr::summarise(season_rating = round(mean(rating_18_49, na.rm = TRUE), 2)) %>%
  ggplot(aes(season, season_rating)) + 
  geom_point()

castaways %>%
  ggplot(aes(season, age)) + 
  geom_boxplot(aes(group = season)) +
  labs(
    title = "Survivor: Distribution of castaway ages throughout the seasons",
    x = "Season",
    y = "Age"
  ) + 
  theme_minimal() + 
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  )
  # color by ???
  ## personality type
```

### Personality Type by Season

```{r}
castaways %>%
  filter(!(is.na(personality_type))) %>%
  count(season, personality_type) %>%
  ggplot(aes(season, n, fill = personality_type)) + 
  geom_bar(stat = "identity", position = "fill") + 
  labs(
    title = "Survivor: Distribution of personality types by season",
    fill = "Personality Type"
  ) + 
  theme_void()
```


### Result by Personality Type

```{r fig.height=8, fig.width=10}
#df<-df%>%mutate(MyQuantileBins = cut(MyContinuous, 
#                                 breaks = unique(quantile(MyContinuous,probs=seq.int(0,1, by=1/numbers_of_bins))), 
#                                                 include.lowest=TRUE))

# as.numeric(cut2(das$wt, g=3))

castaway_result_noise <- filter(count(castaways, result), n < 10)$result
number_of_bins <- 3

castaway_personality <- castaways %>%
  filter(
    !(result %in% castaway_result_noise),
    !(is.na(personality_type))
    ) %>%
  group_by(personality_type) %>%
  dplyr::summarise(
    `Percent of castaways who won the season` = 100*(sum(result == "Sole Survivor") / n()),
    `Percent of castaways who were finalists (winners and runner-ups)` = 100*(sum(str_detect(str_to_lower(result), "(runner-up|sole survivor)")) / n()),
    `Staying Power (sum of order squared, divided by count)` = sum(order^2) / n(),
  )

castaway_personality %>%
  pivot_longer(cols = -personality_type, names_to = "success_metric", values_to = "rate") %>%
  ggplot(aes(reorder_within(personality_type, rate, success_metric), rate)) + 
  geom_bar(aes(fill = success_metric), stat = "identity") + 
  scale_x_reordered() + 
  facet_wrap(~ success_metric, ncol = 1, scales = "free") + 
  labs(
    title = "Survivor: Which personality type was most succesful?",
    x = "Personality Type",
    y = ""
  ) +
  theme_minimal() + 
  theme(
    legend.position = "none",
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  )
```

### Where did all the castaways come from?

Plot chloropleth map per capita.

## Viewers

```{r}
viewers
```

### Viewership over the course of a season

What is the average viewer ship pattern over the course of a season?

```{r}
viewers %>%
  group_by(season) %>%
  dplyr::summarise(
    season_start = min(episode),
    season_end = max(episode)
  ) %>%
  ggplot(aes(season, season_end)) + 
  geom_line()

viewers %>%
  filter(episode < 17) %>%
  group_by(episode) %>%
  dplyr::summarise(
    mean_viewers = mean(viewers, na.rm = TRUE) 
  ) %>%
  ggplot(aes(episode, mean_viewers)) + 
  geom_line()
```


Same question, but for ratings

```{r}
viewers %>%
  ggplot(aes(episode_number_overall, rating_18_49)) + 
  geom_line()
```

```{r}
viewers %>%
  ggplot(aes(episode_number_overall, viewers)) + 
  geom_line()
```

```{r}
viewers %>%
  group_by(season) %>%
  dplyr::summarise(
    mean_rating = mean(rating_18_49, na.rm = TRUE),
    mean_viewers = mean(viewers, na.rm = TRUE)
  ) %>%
  ggplot(aes(mean_viewers, mean_rating)) + 
  geom_point() + 
  geom_smooth(method = "lm")
```

```{r}
res <- lm(viewers$rating_18_49 ~ viewers$viewers)
RSS <- c(crossprod(res$residuals))
MSE <- RSS / length(res$residuals)
RMSE <- sqrt(MSE)
RMSE
```


## Jury Votes



