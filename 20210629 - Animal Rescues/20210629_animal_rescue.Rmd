---
title: "20210629 - Rescue Animals"
author: "Nick Cruickshank"
date: "6/30/2021"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

```{r}
# libraries
library(forcats)
library(glue)
library(lubridate)
library(patchwork)
library(readr)
library(tidyverse)
```

```{r}
# data
animal_rescues <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-06-29/animal_rescues.csv')
```

# Introduction

Data this week comes from [London.gov](https://data.london.gov.uk/dataset/animal-rescue-incidents-attended-by-lfb). 

> Fox in bedroom, dog trapped in wall. The London Fire Brigade responds to hundreds of requests to rescue animals each year. Its monthly-updated spreadsheet of such events goes back to 2009; it lists the location and type of property, the kind of animal and rescue, hours spent, a (very) brief description, and more. [h/t Soph Warnes]

Another [article](https://www.theguardian.com/world/2021/jan/08/animal-rescues-london-fire-brigade-rise-2020-pandemic-year) found that animals rescues increased by 20% in the year of the pandemic (2020). 

> The London fire brigade (LFB) was involved in 755 such incidents â€“ more than two a day. The number of rescues rose by 20% compared with 2019 when there were 602, with the biggest rise coming in the number of non-domestic animals rescued, according to the data.

```{r}
# tidy
## prominent species
top_species <- animal_rescues %>%
  mutate(animal_group_parent = str_to_lower(animal_group_parent)) %>%
  filter(!(str_detect(animal_group_parent, "unknown"))) %>%
  count(animal_group_parent) %>%
  arrange(desc(n)) %>%
  head(6) # very steep drop off after 6 species

top_species_list <- top_species$animal_group_parent
top3_species_list <- head(top_species, 3)$animal_group_parent

## final tidy
ar <- animal_rescues %>%
  filter(
    cal_year != 2021 # this year isn't complete, and therefore might throw off visualization
  ) %>%
  mutate(
    animal_group_parent = str_to_lower(animal_group_parent),
    
    # time
    date_time_of_call = as.POSIXct(date_time_of_call, format = "%d/%m/%Y %H:%M"),
    date = as.Date(date_time_of_call, format = "%d/%m/%Y"),
    floor_year_month = floor_date(date, "months"),
    hour_of_day = hour(date_time_of_call),
    month_day = strftime(date_time_of_call, "%m-%d"),
    month = strftime(date_time_of_call, format = "%b"),
    week = week(date_time_of_call),
    day = day(date_time_of_call),
    
    # special service categories
    special_service_type_category = str_to_lower(special_service_type_category),
    service_category = str_to_title(str_remove(special_service_type_category, "animal rescue from "))
  )

unredacted <- ar %>%
  filter(final_description != "Redacted")
```

```{r}
# values
min_date <- strftime(min(ar$date), format = "%b %d, %Y")
max_date <- strftime(max(ar$date), format = "%b %d, %Y")
```


```{r}
# functions
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
```


# Exploratory Data Analysis

## Notes

```{r}
count(ar, cal_year)
```


`type_of_incident`: Only 'Special Service' represented.

`pump` = truck / unit deployed.

```{r eda_call_origin, fig.height=4, fig.width=10}
count(ar, originof_call) %>%
  arrange(desc(n))
```

I don't think there is much insight to be gleaned from whether the call was made from a landline or mobile device.

# Data Visualization Projects

## Choropleth of animal rescues

## Timeline of animal rescue

By species?

```{r overall_rescue_timeline, fig.height=8, fig.width=8}
ar %>%
  filter(animal_group_parent %in% top3_species_list) %>%
  mutate(animal_group_parent = str_to_title(animal_group_parent)) %>%
  count(floor_year_month, animal_group_parent) %>%
  ggplot(aes(floor_year_month, n)) + 
  geom_line() + 
  facet_wrap(~ animal_group_parent, ncol = 1) + 
  labs(
    title = "Number of animal rescues per month",
    subtitle = "High seasonality observed for birds and cats, not for dogs",
    x = "Date",
    y = "Monthly Rescues"
  )
  
```

### What does an average year look like for animal rescue?

```{r Rescues by Species and Service Type in an Average Year, fig.height=7, fig.width=8}
ar_monthly_species_mode <- ar %>%
  filter(
    animal_group_parent %in% top3_species_list,
    service_category != "Other Animal Assistance"
  ) %>%
  group_by(month, animal_group_parent) %>%
  dplyr::summarise(mode_service = Mode(service_category))

ar_monthly_species_mode %>%
  filter(animal_group_parent == "dog")

month_levels <- c("Jan", "Feb", "Mar", "Apr",
                  "May", "Jun", "Jul", "Aug",
                  "Sep", "Oct", "Nov", "Dec")

df_duration <- round(as.numeric(difftime(max(ar$date_time_of_call), 
                                         min(ar$date_time_of_call), 
                                         unit = "weeks")) / 52.25)

plot_animal_rescue_year_by_species <- function(df = ar, species) {
  plot_title = paste0(str_to_title(species), "s")
  
  plot <- df %>%
    filter(animal_group_parent == species) %>%
    group_by(cal_year, month, week, animal_group_parent) %>%
    dplyr::summarise(n = n()) %>%
    group_by(month, week, animal_group_parent) %>%
    dplyr::summarise(
      avg = mean(n),
      sd = sd(n),
      min = min(n),
      max = max(n)
    ) %>%
    left_join(ar_monthly_species_mode) %>%
    ggplot(aes(week, avg)) +
    geom_line(aes(color = mode_service), size = 1.5) +
    geom_point(aes(color = mode_service), size = 3) + 
    geom_area(aes(fill = mode_service), alpha = 0.65) +
    scale_color_manual(values = c(
      "Below Ground"= "burlywood3",
      "Height" = "lightskyblue1",
      "Water" = "royalblue"
    ), drop = FALSE) +
    scale_fill_manual(values = c(
      "Below Ground"= "burlywood3",
      "Height" = "lightskyblue1",
      "Water" = "royalblue"
    )) +
    facet_wrap(~ factor(month, levels = month_levels), ncol = 12, scales = "free_x") + 
    labs(
      title = plot_title,
      x = "",
      y = "Avg. Weekly Rescues",
      fill = "Rescued From",
      color = "Rescued From"
    ) + 
    theme_dark() + 
    theme(
      plot.background = element_rect(fill = "gray50"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      axis.ticks.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      axis.text.x = element_blank(),
      legend.position = ifelse(species == "dog", "bottom", "none"),
      #legend.position = "bottom",
      legend.background = element_rect(fill = "grey50"),
      plot.title = element_text(hjust = 0.5, size = 14)
    )
  
  plot
}

plot_animal_rescue_year_by_species(ar, "cat") + 
  plot_animal_rescue_year_by_species(ar, "bird") + 
  plot_animal_rescue_year_by_species(ar, "dog") +
  plot_annotation(
    title = glue("Average Weekly Animal Rescues in London over the past {df_duration} years"),
    theme = theme(
      plot.background = element_rect(fill = "grey50"),
      plot.title = element_text(size = 18)
    )
  ) +
  plot_layout(
    ncol = 1,
    guides = "collect"
  ) &  theme(legend.direction = "vertical")
```

### What are the busiest times of day???

```{r hour of day}
ar_hourly_species_mode <- ar %>%
  filter(
    animal_group_parent %in% top3_species_list,
    service_category != "Other Animal Assistance"
  ) %>%
  group_by(hour_of_day, animal_group_parent) %>%
  dplyr::summarise(mode_service = Mode(service_category))

ar %>%
  filter(animal_group_parent == "dog") %>%
  count(animal_group_parent, cal_year, hour_of_day) %>%
  group_by(animal_group_parent, hour_of_day) %>%
  dplyr::summarise(avg = mean(n)) %>%
  left_join(ar_hourly_species_mode) %>%
  replace_na(list(mode_service = "Other")) %>%
  ggplot(aes(hour_of_day, avg)) + 
  geom_bar(aes(fill = mode_service), stat = "identity")
```


### What propery types do most rescues occur at?

```{r}
count(ar, property_type) %>%
  arrange(desc(n))
```

## Where do animals get rescued from the most?

## What animals cost the most to rescue?

Normalize by hours spent?

## What kind of properties do animals most routinely get trapped in?